#!/usr/bin/env node
/**
 * Script pour créer le fichier default.d.ts manquant dans le client Prisma 7 généré
 * Ce fichier est nécessaire pour que TypeScript puisse résoudre les types depuis @prisma/client
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const projectRoot = path.resolve(__dirname, '..');
const prismaClientPath = path.join(projectRoot, 'node_modules', '.prisma', 'client');
const defaultDtsPath = path.join(prismaClientPath, 'default.d.ts');

// Vérifier si le répertoire .prisma/client existe
if (!fs.existsSync(prismaClientPath)) {
  console.warn('⚠️  Le répertoire .prisma/client n\'existe pas. Exécutez "prisma generate" d\'abord.');
  process.exit(0);
}

// Créer le fichier default.d.ts s'il n'existe pas ou s'il doit être mis à jour
const defaultDtsContent = `// Type definitions for Prisma Client 7
// This file re-exports all types from the generated client
// Auto-generated by scripts/fix-prisma-types.mjs
export * from './client.js';
`;

// Corriger default.mjs pour pointer vers client.ts (avec tsx, Node.js peut charger .ts)
// Approche inspirée de Trigger.dev : traiter Prisma comme dépendance externe
// Référence: https://trigger.dev/changelog/prisma-7-integration
const defaultMjsPath = path.join(prismaClientPath, 'default.mjs');
const defaultMjsContent = `// ESM export for Prisma 7
// Auto-generated by scripts/fix-prisma-types.mjs
// With tsx loader, Node.js can import .ts files directly
// This fixes the issue where default.mjs tries to import client.js which doesn't exist
export * from './client.ts';
`;

const defaultJsPath = path.join(prismaClientPath, 'default.js');
// Note: default.js doit être compatible CommonJS pour être importé par @prisma/client/default.js
// Le fichier @prisma/client/default.js fait: require('.prisma/client/default')
// Avec tsx loader, Node.js peut charger directement les fichiers .ts
// On crée un wrapper qui charge directement client.ts (tsx loader requis)
const defaultJsContent = `// CommonJS wrapper for Prisma 7
// Auto-generated by scripts/fix-prisma-types.mjs
// This file is required by @prisma/client/default.js which does: require('.prisma/client/default')
// With tsx loader (NODE_OPTIONS='--import tsx'), Node.js can load .ts files directly
// This is the CommonJS entry point that loads the TypeScript client
module.exports = require('./client.ts');
`;

try {
  fs.writeFileSync(defaultDtsPath, defaultDtsContent, 'utf-8');
  fs.writeFileSync(defaultJsPath, defaultJsContent, 'utf-8');
  fs.writeFileSync(defaultMjsPath, defaultMjsContent, 'utf-8');
  console.log('✅ Fichiers default.d.ts, default.js et default.mjs créés/mis à jour pour Prisma 7');
  console.log('ℹ️  default.mjs pointe maintenant vers client.ts (tsx loader requis)');
} catch (error) {
  console.error('❌ Erreur lors de la création des fichiers:', error);
  process.exit(1);
}

