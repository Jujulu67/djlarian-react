#!/usr/bin/env node
/**
 * Script pour créer le fichier default.d.ts manquant dans le client Prisma 7 généré
 * Ce fichier est nécessaire pour que TypeScript puisse résoudre les types depuis @prisma/client
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const projectRoot = path.resolve(__dirname, '..');
const prismaClientPath = path.join(projectRoot, 'node_modules', '.prisma', 'client');
const defaultDtsPath = path.join(prismaClientPath, 'default.d.ts');

// Vérifier si le répertoire .prisma/client existe
if (!fs.existsSync(prismaClientPath)) {
  console.warn('⚠️  Le répertoire .prisma/client n\'existe pas. Exécutez "prisma generate" d\'abord.');
  process.exit(0);
}

// Créer le fichier default.d.ts s'il n'existe pas ou s'il doit être mis à jour
// Il doit réexporter depuis index.d.ts pour avoir accès au namespace Prisma
const defaultDtsContent = `// Type definitions for Prisma Client 7
// This file re-exports all types from the generated client
// Auto-generated by scripts/fix-prisma-types.mjs
export * from './index';
`;

// Corriger default.mjs pour pointer vers index.js (point d'entrée principal de Prisma)
// index.js supporte à la fois CommonJS et ESM selon package.json
// En production, on doit utiliser index.js et non client.ts car Node.js ne peut pas charger .ts sans tsx
const defaultMjsPath = path.join(prismaClientPath, 'default.mjs');
const defaultMjsContent = `// ESM export for Prisma 7
// Auto-generated by scripts/fix-prisma-types.mjs
// In production, we use index.js (main entry point) instead of client.ts
// because Node.js cannot load .ts files without tsx loader in production
// index.js supports both CommonJS and ESM according to package.json
export * from './index.js';
`;

const defaultJsPath = path.join(prismaClientPath, 'default.js');
// Note: default.js doit être compatible CommonJS pour être importé par @prisma/client/default.js
// Le fichier @prisma/client/default.js fait: require('.prisma/client/default')
// En production, on doit utiliser client.js (généré par Prisma) et non client.ts
// car Node.js ne peut pas charger .ts sans tsx loader en production
const defaultJsContent = `// CommonJS wrapper for Prisma 7
// Auto-generated by scripts/fix-prisma-types.mjs
// This file is required by @prisma/client/default.js which does: require('.prisma/client/default')
// In production, we use client.js (generated by Prisma) instead of client.ts
// because Node.js cannot load .ts files without tsx loader in production
module.exports = require('./client.js');
`;

try {
  fs.writeFileSync(defaultDtsPath, defaultDtsContent, 'utf-8');
  fs.writeFileSync(defaultJsPath, defaultJsContent, 'utf-8');
  fs.writeFileSync(defaultMjsPath, defaultMjsContent, 'utf-8');
  console.log('✅ Fichiers default.d.ts, default.js et default.mjs créés/mis à jour pour Prisma 7');
  console.log('ℹ️  default.js pointe vers client.js, default.mjs pointe vers index.js (compatible production)');
} catch (error) {
  console.error('❌ Erreur lors de la création des fichiers:', error);
  process.exit(1);
}

